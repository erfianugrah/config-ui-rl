---
import Layout from '../layouts/Layout.astro';
import RuleForm from '../components/RuleForm.svelte';
import RuleModal from '../components/RuleModal.svelte';
import ViewRuleModal from '../components/ViewRuleModal.svelte';
import { loadConfiguration } from '../lib/config-utils';
import { ADD_RULE_BUTTON_TEXT } from '../lib/config-variables';

let config;
let error;
try {
  console.log('Attempting to load configuration...');
  const origin = Astro.url.origin;
  const fullUrl = new URL('/api/config', origin).toString();
  const response = await fetch(fullUrl);
  
  if (!response.ok) {
    const responseText = await response.text();
    console.error('Error response:', responseText);
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  const contentType = response.headers.get("content-type");
  if (!contentType || !contentType.includes("application/json")) {
    const responseText = await response.text();
    console.error('Unexpected content type:', contentType);
    console.error('Response text:', responseText);
    throw new Error(`Expected JSON, got ${contentType}`);
  }
  
  config = await response.json();
  console.log('Configuration loaded successfully:', config);
} catch (e) {
  console.error('Error loading configuration:', e);
  error = e.message;
}
---

<Layout title="Rate Limit Configuration">
  <h1 class="text-3xl font-bold mb-8 text-center">Rate Limit Configuration</h1>
  
  {error && <div class="error-message bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
    <strong class="font-bold">Error:</strong>
    <span class="block sm:inline">{error}</span>
  </div>}
  
  <div id="ruleModals" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
    {config && config.rules && config.rules.map((rule, index) => (
      <RuleModal client:load {rule} {index} />
    ))}
  </div>

  <button id="addNewRule" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
    {ADD_RULE_BUTTON_TEXT}
  </button>

  <div id="configForm" class="hidden">
    <RuleForm client:load />
  </div>

  <div id="viewRuleModal" class="hidden">
    <ViewRuleModal client:load />
  </div>

  <div id="message" class="mt-4 text-center font-bold"></div>
</Layout>

<script>
  import { showSaveSuccess, showSaveError } from '../lib/ui-utils';
  import { saveConfiguration } from '../lib/config-utils';
  import { initDragAndDrop } from '../lib/drag-drop-utils';

  let currentRules = [];

  document.addEventListener('astro:page-load', () => {
    console.log('astro:page-load event triggered');
    const addNewRuleButton = document.getElementById('addNewRule');
    const ruleModals = document.getElementById('ruleModals');
    const configForm = document.getElementById('configForm');
    const viewRuleModal = document.getElementById('viewRuleModal');

    currentRules = JSON.parse(ruleModals.getAttribute('data-rules') || '[]');
    console.log('Current rules:', currentRules);

    addNewRuleButton.addEventListener('click', () => {
      console.log('Add new rule button clicked');
      ruleModals.classList.add('hidden');
      addNewRuleButton.classList.add('hidden');
      configForm.classList.remove('hidden');
    });

    const ruleForm = document.querySelector('astro-island[component-url$="RuleForm.svelte"]');
    ruleForm.addEventListener('save', async (event) => {
      console.log('Save event received:', event.detail);
      const { rule, index } = event.detail;
      
      if (index !== undefined && index < currentRules.length) {
        currentRules[index] = rule;
      } else {
        currentRules.push(rule);
      }

      try {
        console.log('Attempting to save configuration...');
        await saveConfiguration({ rules: currentRules });
        console.log('Configuration saved successfully');
        showSaveSuccess();
        updateRuleModals();
      } catch (error) {
        console.error('Error saving configuration:', error);
        showSaveError(error);
      }
    });

    ruleModals.addEventListener('view', (event) => {
      console.log('View event received:', event.detail);
      const { rule } = event.detail;
      const viewModal = viewRuleModal.querySelector('astro-island');
      viewModal.setAttribute('rule', JSON.stringify(rule));
      viewRuleModal.classList.remove('hidden');
    });

    ruleModals.addEventListener('edit', (event) => {
      console.log('Edit event received:', event.detail);
      const { rule, index } = event.detail;
      ruleModals.classList.add('hidden');
      addNewRuleButton.classList.add('hidden');
      configForm.classList.remove('hidden');
      ruleForm.setAttribute('rule', JSON.stringify(rule));
      ruleForm.setAttribute('index', index);
    });

    ruleModals.addEventListener('delete', async (event) => {
      console.log('Delete event received:', event.detail);
      const { index } = event.detail;
      if (confirm('Are you sure you want to delete this rule?')) {
        currentRules.splice(index, 1);
        try {
          console.log('Attempting to save configuration after delete...');
          await saveConfiguration({ rules: currentRules });
          console.log('Configuration saved successfully after delete');
          showSaveSuccess();
          updateRuleModals();
        } catch (error) {
          console.error('Error saving configuration after delete:', error);
          showSaveError(error);
        }
      }
    });

    viewRuleModal.querySelector('astro-island').addEventListener('close', () => {
      console.log('View modal close event received');
      viewRuleModal.classList.add('hidden');
    });

    initDragAndDrop(ruleModals, async (newOrder) => {
      console.log('New order after drag and drop:', newOrder);
      currentRules = newOrder.map(index => currentRules[index]);
      try {
        console.log('Attempting to save configuration after reorder...');
        await saveConfiguration({ rules: currentRules });
        console.log('Configuration saved successfully after reorder');
        showSaveSuccess();
        updateRuleModals();
      } catch (error) {
        console.error('Error saving configuration after reorder:', error);
        showSaveError(error);
      }
    });
  });

  function updateRuleModals() {
    console.log('Updating rule modals');
    const ruleModals = document.getElementById('ruleModals');
    ruleModals.innerHTML = '';
    currentRules.forEach((rule, index) => {
      const ruleModal = document.createElement('astro-island');
      ruleModal.setAttribute('component-url', '/src/components/RuleModal.svelte');
      ruleModal.setAttribute('component-export', 'default');
      ruleModal.setAttribute('renderer-url', '/src/renderers/renderer.svelte.js');
      ruleModal.setAttribute('props', JSON.stringify({ rule, index }));
      ruleModals.appendChild(ruleModal);
    });
    console.log('Rule modals updated');
  }
</script>
